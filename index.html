<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>GeoCheck</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-slate-100 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // =========================
    // CONFIG (EDIT THESE 2)
    // =========================
    const API_URL = "https://script.google.com/macros/s/AKfycbzDSSV_vLRQEVzayR9nwxXCcavylrrw9cXXJatPrQ-D8U_2oqq7WuNOURpTvbKmTor_9w/exec";
    const API_SECRET = "ISE_TOKEN";

    // Email -> Employee ID map (frontend display/help; backend also enforces)
    const EMAIL_TO_ID = {
      "sasiwipa.p@chula.ac.th": "10016090",
      "supaphan.p@chula.ac.th": "10016023",
      "sawarach.s@chula.ac.th": "10025894",
      "phachphicha.p@chula.ac.th": "10022498",
      "supatcharin.n@chula.ac.th": "10023396",
      "sittipun.w@chula.ac.th": "10016260",
      "suputtra.d@chula.ac.th": "10016026",
      "pamigar.m@chula.ac.th": "10024408",
      "fonthong.t@chula.ac.th": "10024107",
      "panyata.s@chula.ac.th": "10023738",
      "punsita.b@chula.ac.th": "10024402",
      "jirasaya.c@chula.ac.th": "10024112",
      "nattanan.s@chula.ac.th": "10024839",
      "waranya.ph@chula.ac.th": "10024837",
      "thanatpong.t@chula.ac.th": "10025137",
      "napassorn.p@chula.ac.th": "10025895",
      "thanaphon.a@chula.ac.th": "20260101",
      "thosaphol.t@chula.ac.th": "20260102",
      "nat.s@chula.ac.th": "20260103",
      "dolaporn.a@chula.ac.th": "20260104",
      "nichayanuch.l@chula.ac.th": "20260105",
      "weetima.w@chula.ac.th": "20260106",
      "jirachaya.so@chula.ac.th": "20260108"
    };

    const normEmail = (s) => String(s || "").trim().toLowerCase();

    // IMPORTANT: no Content-Type header -> avoids CORS preflight
    async function postApi(payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ ...payload, secret: API_SECRET })
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { ok: false, error: "Bad JSON: " + text }; }
      return data;
    }

    function App() {
      const [toast, setToast] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [authMode, setAuthMode] = useState("login"); // login | register
      const [authForm, setAuthForm] = useState({ name: "", email: "", password: "" });

      const [location, setLocation] = useState({ loading: false, coords: null, error: null });
      const [logs, setLogs] = useState([]);

      const officeLocations = [
        { name: "ISE_Headquarters", lat: 13.73656068, lng: 100.5333925, radius: 30 },
        { name: "ChulaPat_14",     lat: 13.74406954, lng: 100.525551,  radius: 30 }
      ];

      const showToast = (msg, type="ok") => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 3000);
      };

      const inferredId = useMemo(() => {
        const e = normEmail(authForm.email);
        return EMAIL_TO_ID[e] || "";
      }, [authForm.email]);

      // Ping backend once on load
      useEffect(() => {
        (async () => {
          const r = await postApi({ action: "ping" });
          if (!r.ok) showToast("API not ready: " + (r.error || "unknown"), "err");
        })();
      }, []);

      const calcDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371e3;
        const toRad = (x) => x * Math.PI / 180;
        const φ1 = toRad(lat1), φ2 = toRad(lat2);
        const dφ = toRad(lat2 - lat1);
        const dλ = toRad(lon2 - lon1);
        const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
      };

      const verifyLocation = () => {
        if (location.loading) return;
        if (!navigator.geolocation) {
          setLocation({ loading:false, coords:null, error:"Geolocation not supported" });
          return;
        }
        setLocation({ loading:true, coords:null, error:null });
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            setLocation({
              loading:false,
              coords: { lat: pos.coords.latitude, lng: pos.coords.longitude },
              error:null
            });
          },
          (err) => {
            setLocation({ loading:false, coords:null, error:"Location denied / unavailable" });
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      };

      const nearestOffice = useMemo(() => {
        if (!location.coords) return null;
        let best = null;
        let bestDist = Infinity;
        for (const o of officeLocations) {
          const d = calcDistance(location.coords.lat, location.coords.lng, o.lat, o.lng);
          if (d < bestDist) { bestDist = d; best = { ...o, distance: Math.round(d) }; }
        }
        return best;
      }, [location.coords]);

      const canCheck = useMemo(() => {
        if (!currentUser?.id) return false;          // must have id
        if (!nearestOffice) return false;
        return nearestOffice.distance <= nearestOffice.radius;
      }, [currentUser, nearestOffice]);

      // ---------- AUTH ----------
      const register = async () => {
        const name = authForm.name.trim();
        const email = authForm.email.trim();
        const password = authForm.password.trim();

        if (!name || !email || !password) {
          showToast("Fill all fields", "err");
          return;
        }

        const r = await postApi({
          action: "register",
          name,
          email,
          password,
          id: inferredId // optional; backend also infers
        });

        if (!r.ok) {
          showToast(r.error || "Register failed", "err");
          return;
        }

        setCurrentUser(r.user);
        setAuthForm({ name:"", email:"", password:"" });
        showToast("Registered!");
        verifyLocation();
      };

      const login = async () => {
        const email = authForm.email.trim();
        const password = authForm.password.trim();
        if (!email || !password) { showToast("Enter email & password", "err"); return; }

        const r = await postApi({ action:"login", email, password });
        if (!r.ok) { showToast(r.error || "Login failed", "err"); return; }

        setCurrentUser(r.user);
        setAuthForm({ name:"", email:"", password:"" });
        showToast("Welcome " + (r.user?.name || ""));
        verifyLocation();

        if (!r.user?.id) {
          showToast("Your employee_id is not assigned yet (ask admin)", "err");
        }
      };

      const logout = () => {
        setCurrentUser(null);
        setLogs([]);
        setLocation({ loading:false, coords:null, error:null });
      };

      // ---------- CHECK IN/OUT ----------
      const doLog = async (eventType) => {
        if (!currentUser) return;

        if (!currentUser.id) {
          showToast("No employee_id. Ask admin or use mapped email.", "err");
          return;
        }

        if (!nearestOffice) {
          showToast("Verify location first", "err");
          verifyLocation();
          return;
        }

        if (nearestOffice.distance > nearestOffice.radius) {
          showToast("Too far from office (" + nearestOffice.name + ")", "err");
          return;
        }

        const now = new Date();
        const dateISO = now.toISOString().slice(0,10); // YYYY-MM-DD
        const timeStr = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });

        const payload = {
          action: "log",
          event: eventType,
          emp_id: currentUser.id,
          emp_name: currentUser.name,
          date: dateISO,
          location: nearestOffice.name,
          coords: `${location.coords.lat.toFixed(6)}, ${location.coords.lng.toFixed(6)}`,
          timestamp_id: String(Date.now()),
          timestamp: now.toISOString()
        };

        if (eventType === "IN") {
          payload.checkin_time = timeStr;
          payload.latetime = 0;
          payload.latecheck = "FALSE";
          payload.reason = "-";
        } else {
          payload.checkout_time = timeStr;
        }

        const r = await postApi(payload);
        if (!r.ok) {
          showToast(r.error || "Failed to write log", "err");
          return;
        }

        // update local UI
        setLogs(prev => [{ ...payload, local_time: timeStr }, ...prev]);
        showToast(eventType === "IN" ? "Checked IN (saved to sheet)" : "Checked OUT (saved to sheet)");
      };

      return (
        <div className="min-h-screen p-4">
          {toast && (
            <div className={`fixed top-4 right-4 px-4 py-2 rounded-lg text-white shadow
              ${toast.type==="err" ? "bg-red-600" : "bg-slate-800"}`}>
              {toast.msg}
            </div>
          )}

          <div className="max-w-md mx-auto">
            <div className="text-2xl font-bold mb-4">GeoCheck</div>

            {!currentUser ? (
              <div className="bg-white rounded-xl border p-4 shadow-sm">
                <div className="flex gap-2 mb-4">
                  <button className={`flex-1 py-2 rounded ${authMode==="login"?"bg-blue-600 text-white":"bg-slate-100"}`}
                    onClick={()=>setAuthMode("login")}>Login</button>
                  <button className={`flex-1 py-2 rounded ${authMode==="register"?"bg-emerald-600 text-white":"bg-slate-100"}`}
                    onClick={()=>setAuthMode("register")}>Register</button>
                </div>

                {authMode==="register" && (
                  <>
                    <label className="text-sm font-medium">Full Name</label>
                    <input className="w-full border rounded p-2 mb-3"
                      value={authForm.name}
                      onChange={e=>setAuthForm({...authForm, name:e.target.value})}
                      placeholder="Full name"
                    />
                  </>
                )}

                <label className="text-sm font-medium">Email</label>
                <input className="w-full border rounded p-2 mb-2"
                  value={authForm.email}
                  onChange={e=>setAuthForm({...authForm, email:e.target.value})}
                  placeholder="name@chula.ac.th"
                />

                {authMode==="register" && (
                  <div className="text-xs mb-3">
                    Employee ID (auto):{" "}
                    <span className="font-mono font-bold">
                      {inferredId || "(not found in map — admin will assign)"}
                    </span>
                  </div>
                )}

                <label className="text-sm font-medium">Password</label>
                <input className="w-full border rounded p-2 mb-4" type="password"
                  value={authForm.password}
                  onChange={e=>setAuthForm({...authForm, password:e.target.value})}
                  placeholder="••••••••"
                />

                {authMode==="login" ? (
                  <button onClick={login} className="w-full bg-blue-600 text-white rounded-lg py-2 font-medium">
                    Sign In
                  </button>
                ) : (
                  <button onClick={register} className="w-full bg-emerald-600 text-white rounded-lg py-2 font-medium">
                    Create Account
                  </button>
                )}
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-white rounded-xl border p-4 shadow-sm flex items-center justify-between">
                  <div>
                    <div className="font-semibold">{currentUser.name}</div>
                    <div className="text-xs text-slate-500">
                      ID: <span className="font-mono">{currentUser.id || "(missing)"}</span>
                    </div>
                    <div className="text-xs text-slate-500">{currentUser.email}</div>
                  </div>
                  <button onClick={logout} className="text-sm bg-slate-100 rounded px-3 py-1">Logout</button>
                </div>

                <div className="bg-white rounded-xl border p-4 shadow-sm">
                  <div className="font-semibold mb-2">Location</div>
                  {!location.coords ? (
                    <>
                      <button onClick={verifyLocation} className="w-full bg-slate-800 text-white rounded-lg py-2">
                        {location.loading ? "Locating..." : "Verify Location"}
                      </button>
                      {location.error && <div className="text-red-600 text-sm mt-2">{location.error}</div>}
                    </>
                  ) : (
                    <>
                      <div className="text-sm">
                        Nearest: <b>{nearestOffice?.name}</b> ({nearestOffice?.distance}m / radius {nearestOffice?.radius}m)
                      </div>
                      <button onClick={verifyLocation} className="text-xs text-blue-600 mt-2 underline">Refresh GPS</button>
                    </>
                  )}
                </div>

                <div className="bg-white rounded-xl border p-4 shadow-sm space-y-2">
                  <button
                    onClick={()=>doLog("IN")}
                    disabled={!canCheck}
                    className={`w-full rounded-lg py-3 font-bold ${canCheck ? "bg-blue-600 text-white" : "bg-slate-200 text-slate-500"}`}>
                    CHECK IN (Save to Sheet)
                  </button>
                  <button
                    onClick={()=>doLog("OUT")}
                    disabled={!canCheck}
                    className={`w-full rounded-lg py-3 font-bold ${canCheck ? "bg-red-600 text-white" : "bg-slate-200 text-slate-500"}`}>
                    CHECK OUT (Save to Sheet)
                  </button>

                  {!currentUser.id && (
                    <div className="text-xs text-red-600">
                      Your employee_id is missing. Use a mapped email or ask admin to fill ID in Users sheet.
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-xl border p-4 shadow-sm">
                  <div className="font-semibold mb-2">Recent Local Actions</div>
                  {logs.length === 0 ? (
                    <div className="text-sm text-slate-500">No actions yet.</div>
                  ) : (
                    <div className="space-y-2">
                      {logs.slice(0,5).map((l, idx)=>(
                        <div key={idx} className="text-xs bg-slate-50 rounded p-2">
                          <div><b>{l.event}</b> {l.date} {l.local_time}</div>
                          <div className="text-slate-500">{l.location} • {l.coords}</div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
