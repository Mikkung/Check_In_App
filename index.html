<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GeoCheck - Employee Attendance</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html { -webkit-tap-highlight-color: transparent; }
    body { -webkit-font-smoothing: antialiased; }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ===================== EDIT HERE =====================
    const API_URL = "https://script.google.com/macros/s/AKfycbxZ-eQr5Zwz1FFihvzdKpzGYSjHd4gt3FGp3aBouf5blyDzcqJBezBioYQz1Of9vKSDkw/exec";
    const SECRET  = "ISE_TOKEN";
    // =====================================================

    // --- Icons ---
    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );

    const Icons = {
      MapPin: (p) => <Icon {...p} path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />,
      CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
      AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
      Navigation: (p) => <Icon {...p} path={<><polygon points="3 11 22 2 13 21 11 13 3 11"/></>} />,
      LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />,
      LogIn: (p) => <Icon {...p} path={<><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></>} />,
      UserPlus: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>} />,
      BarChart: (p) => <Icon {...p} path={<><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></>} />,
    };

    // --- Utils ---
    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Δφ/2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    };

    const pad2 = (n) => String(n).padStart(2, "0");
    const dateKey = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; // yyyy-MM-dd
    const timeHHMM = (d = new Date()) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    const formatClock = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Get Device ID Function
    function getDeviceId() {
      let id = localStorage.getItem("geocheck_device_id");
      if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random());
        localStorage.setItem("geocheck_device_id", id);
      }
      return id;
    }
      
    
    async function apiPost(payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ ...payload, secret: SECRET }),
        redirect: "follow",
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } 
      catch { data = { ok:false, error:"Invalid JSON from server", raw:text }; }
      return data;
    }

    // --- UI Components ---
    const Button = ({ children, onClick, variant='primary', disabled=false, className='' }) => {
      const base = "w-full flex items-center justify-center px-4 py-3 rounded-lg font-semibold transition active:scale-[0.99] disabled:opacity-50 disabled:pointer-events-none";
      const variants = {
        primary: "bg-blue-600 text-white hover:bg-blue-700",
        success: "bg-emerald-600 text-white hover:bg-emerald-700",
        danger: "bg-red-600 text-white hover:bg-red-700",
        ghost: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
      };
      return <button className={`${base} ${variants[variant]} ${className}`} onClick={onClick} disabled={disabled}>{children}</button>;
    };

    const Card = ({ children, className='' }) => (
      <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>{children}</div>
    );

    const Input = ({ label, type="text", value, onChange, placeholder }) => (
      <div className="mb-4">
        <label className="block text-sm font-medium text-slate-700 mb-1">{label}</label>
        <input
          type={type}
          value={value}
          onChange={onChange}
          placeholder={placeholder}
          className="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
    );

    const ProgressBar = ({ current, max, label }) => {
      const pct = Math.min(100, Math.max(0, (max ? (current/max)*100 : 0)));
      const danger = current > max;
      return (
        <div className="mb-4">
          <div className="flex justify-between text-xs mb-1 font-medium text-slate-600">
            <span>{label}</span>
            <span>{current} / {max}</span>
          </div>
          <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
            <div className={`h-2.5 rounded-full transition-all duration-500 ${danger ? "bg-red-500" : "bg-indigo-500"}`} style={{ width: `${pct}%` }} />
          </div>
        </div>
      );
    };

    // ===================== APP =====================
    function App() {
      const [loading, setLoading] = useState(false);
      const [toast, setToast] = useState(null);

      const [currentUser, setCurrentUser] = useState(null);
      const [authMode, setAuthMode] = useState("login"); // login|register

      const [authForm, setAuthForm] = useState({ name:"", email:"", password:"" });
      const [lateReason, setLateReason] = useState("");

      // config
      const [config] = useState({
        startTime: "10:00",
        maxLateCount: 6,
        maxLateMinutes: 180,
        locations: [
          { name: "ISE_Headquarters", lat: 13.73656068, lng: 100.5333925, radius: 10 },
          { name: "ChulaPat_14",      lat: 13.74406954, lng: 100.525551,  radius: 10 },
        ],
      });

      const [locationStatus, setLocationStatus] = useState({
        coords: null, matchedLocation: null, distance: null, error: null, loading: false
      });

      const [logs, setLogs] = useState([]);
      const [clock, setClock] = useState(new Date());

      const notify = (msg, type="ok") => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 3000);
      };

      // load session
      useEffect(() => {
        const saved = localStorage.getItem("geocheck_user_v1");
        if (saved) {
          try { setCurrentUser(JSON.parse(saved)); } catch {}
        }
      }, []);

      useEffect(() => {
        if (currentUser) localStorage.setItem("geocheck_user_v1", JSON.stringify(currentUser));
        else localStorage.removeItem("geocheck_user_v1");
      }, [currentUser]);

      // clock tick
      useEffect(() => {
        const t = setInterval(() => setClock(new Date()), 1000);
        return () => clearInterval(t);
      }, []);

      // fetch logs after login
      const refreshLogs = async (emp_id) => {
        const r = await apiPost({ action:"fetchLogs", emp_id });
        if (!r.ok) throw new Error(r.error || "fetchLogs failed");
        setLogs(r.logs || []);
      };

      useEffect(() => {
        if (currentUser?.id) {
          refreshLogs(currentUser.id).catch(err => notify(err.message, "err"));
        }
      }, [currentUser?.id]);

      // geolocation
      const getLocation = () => {
        if (locationStatus.loading) return;
        setLocationStatus(s => ({ ...s, loading:true, error:null }));

        if (!navigator.geolocation) {
          setLocationStatus({ loading:false, error:"Geolocation not supported", coords:null, matchedLocation:null, distance:null });
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            let closest = null;
            let minD = Infinity;

            config.locations.forEach(loc => {
              const d = calculateDistance(latitude, longitude, loc.lat, loc.lng);
              if (d < minD) { minD = d; closest = loc; }
            });

            setLocationStatus({
              loading:false,
              coords:{ lat: latitude, lng: longitude },
              matchedLocation: closest,
              distance: Math.round(minD),
              error:null
            });
          },
          (err) => {
            const msg = err.code === 1 ? "Please allow location access in browser settings." : "Unable to retrieve location";
            setLocationStatus({ loading:false, error: msg, coords:null, matchedLocation:null, distance:null });
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      };

      useEffect(() => {
        if (currentUser && !locationStatus.coords && !locationStatus.loading) getLocation();
      }, [currentUser]);

      // derived: today row
      const todayKey = dateKey(new Date());
      const todayRow = useMemo(() => logs.find(r => r.date === todayKey) || null, [logs, todayKey]);

      const status = useMemo(() => {
        const checkedIn  = !!(todayRow && todayRow.checkin_time && todayRow.checkin_time !== "-");
        const checkedOut = !!(todayRow && todayRow.checkout_time && todayRow.checkout_time !== "-");
        return {
          checkedIn,
          checkedOut,
          checkInTime: todayRow?.checkin_time || null,
          checkOutTime: todayRow?.checkout_time || null,
        };
      }, [todayRow]);

      // monthly stats
      const monthlyStats = useMemo(() => {
        if (!currentUser?.id) return { lateCount:0, lateMinutes:0 };
        const now = new Date();
        const ym = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
        let cnt = 0, mins = 0;

        logs.forEach(r => {
          if (r.emp_id !== currentUser.id) return;
          if (!String(r.date || "").startsWith(ym)) return;
          const isLate = String(r.latecheck || "").toUpperCase() === "TRUE" || Number(r.latetime || 0) > 0;
          if (isLate) {
            cnt += 1;
            mins += Number(r.latetime || 0);
          }
        });

        return { lateCount: cnt, lateMinutes: mins };
      }, [logs, currentUser?.id]);

      // auth
      const handleRegister = async () => {
        if (!authForm.name || !authForm.email || !authForm.password) {
          showNotification("All fields are required", "error");
          return;
        }
      
        const resp = await apiPost({
          action: "register",
          name: authForm.name,
          email: authForm.email,
          password: authForm.password,
          device_id: getDeviceId(),
        });
      
        if (!resp.ok) {
          showNotification(resp.error || "Register failed", "error");
          return;
        }
      
        setCurrentUser(resp.user); // {id,name,email}
        showNotification("Account created successfully!");
      };
      
      const handleLogin = async () => {
        if (!authForm.email || !authForm.password) {
          showNotification("Please enter Email and Password", "error");
          return;
        }
      
        const resp = await apiPost({
          action: "login",
          email: authForm.email,
          password: authForm.password,
          device_id: getDeviceId(),
        });
      
        if (!resp.ok) {
          if (resp.error_code === "DEVICE_MISMATCH") {
            showNotification("เปลี่ยนเครื่องแล้ว ต้องให้ Admin approve ก่อน", "error");
          } else {
            showNotification(resp.error || "Login failed", "error");
          }
          return;
        }
      
        setCurrentUser(resp.user);
        showNotification(`Welcome back, ${resp.user.name}`);
      };

      const handleLogout = () => {
        if (confirm("Log out?")) {
          setCurrentUser(null);
          setLogs([]);
          setLateReason("");
          setLocationStatus({ coords:null, matchedLocation:null, distance:null, error:null, loading:false });
        }
      };

      // check-in/out
      const handleAction = async (eventType) => {
        if (!currentUser?.id) { notify("No user", "err"); return; }

        if (!locationStatus.coords) {
          notify("Please verify your location first", "err");
          getLocation();
          return;
        }

        const limit = locationStatus.matchedLocation?.radius || 10;
        if (locationStatus.distance > limit) {
          notify(`Too far from ${locationStatus.matchedLocation?.name || "office"}`, "err");
          return;
        }

        // guard
        if (eventType === "IN" && status.checkedIn && !status.checkedOut) {
          notify("Already checked in today", "err");
          return;
        }
        if (eventType === "OUT" && !status.checkedIn) {
          notify("No check-in found for today", "err");
          return;
        }
        if (eventType === "OUT" && status.checkedOut) {
          notify("Already checked out today", "err");
          return;
        }

        const deviceId = getDeviceId();
        const email = currentUser.email;
      
        if (type === "IN") {
          const resp = await apiPost({
            action: "log",
            event: "IN",
            email,
            device_id: deviceId,
            coords: `${locationStatus.coords.lat.toFixed(6)}, ${locationStatus.coords.lng.toFixed(6)}`,
            location: locationStatus.matchedLocation?.name || "-",
            reason: isLate ? lateReason : "-",
            latetime: isLate ? lateMinutes : 0,
            latecheck: isLate ? "TRUE" : "FALSE",
          });
      
          if (!resp.ok) {
            showNotification(resp.error || "Check-in failed", "error");
            return;
          }
      
          // เก็บ session_id ไว้ใช้ตอน OUT
          localStorage.setItem(`geocheck_session_${email}`, resp.session_id);
      
          showNotification("Successfully Checked In!");
          setLateReason("");
          return;
        }
      
        // OUT
        const sessionId = localStorage.getItem(`geocheck_session_${email}`) || "";
      
        const resp = await apiPost({
          action: "log",
          event: "OUT",
          email,
          device_id: deviceId,
          session_id: sessionId,
        });
      
        if (!resp.ok) {
          showNotification(resp.error || "Check-out failed", "error");
          return;
        }
      
        localStorage.removeItem(`geocheck_session_${email}`);
        showNotification("Successfully Checked Out!");
      };
      
        const now = new Date();
        const [sh, sm] = config.startTime.split(":").map(Number);
        const workStart = new Date(now);
        workStart.setHours(sh, sm, 0, 0);

        let isLate = false;
        let lateMinutes = 0;

        if (eventType === "IN") {
          if (now > workStart) {
            isLate = true;
            lateMinutes = Math.floor((now - workStart) / 60000);
          }
          if (isLate && !lateReason.trim()) {
            notify("Late reason required for Check-In", "err");
            return;
          }
        }

        setLoading(true);
        try {
          const payload = {
            action: "log",
            event: eventType,
            emp_id: currentUser.id,
            emp_name: currentUser.name || "",
            date: dateKey(now),                     // yyyy-MM-dd (IMPORTANT)
            checkin_time: eventType === "IN" ? timeHHMM(now) : undefined,
            checkout_time: eventType === "OUT" ? timeHHMM(now) : undefined,
            latetime: eventType === "IN" ? lateMinutes : undefined,
            latecheck: eventType === "IN" ? (isLate ? "TRUE" : "FALSE") : undefined,
            reason: eventType === "IN" ? (isLate ? lateReason : "-") : undefined,
            location: locationStatus.matchedLocation?.name || "-",
            coords: `${locationStatus.coords.lat.toFixed(6)}, ${locationStatus.coords.lng.toFixed(6)}`,
            timestamp_id: String(Date.now()),
            timestamp: now.toISOString(),
          };

          const r = await apiPost(payload);
          if (!r.ok) throw new Error(r.error || "Log failed");

          if (eventType === "IN") setLateReason("");
          notify(eventType === "IN" ? "Checked In saved to Sheet" : "Checked Out saved to Sheet");

          // refresh from sheet (so OUT updates the correct row)
          await refreshLogs(currentUser.id);

        } catch (e) {
          notify(e.message, "err");
        } finally {
          setLoading(false);
        }
      };

      // --- UI ---
      const isLateNow = (() => {
        const [sh, sm] = config.startTime.split(":").map(Number);
        const t = new Date(clock);
        const ws = new Date(clock);
        ws.setHours(sh, sm, 0, 0);
        return t > ws;
      })();

      return (
        <div className="min-h-screen bg-slate-100 pb-12">
          {toast && (
            <div className={`fixed top-4 right-4 z-50 px-5 py-3 rounded-lg shadow-lg text-white font-semibold
              ${toast.type === "err" ? "bg-red-600" : "bg-slate-800"}`}>
              {toast.msg}
            </div>
          )}

          {!currentUser ? (
            <div className="min-h-screen flex items-center justify-center p-4">
              <div className="w-full max-w-md">
                <div className="text-center mb-6">
                  <div className="inline-block bg-blue-600 text-white p-4 rounded-2xl shadow-lg shadow-blue-500/30 mb-3">
                    <Icons.CheckCircle size={44} />
                  </div>
                  <h1 className="text-3xl font-extrabold text-slate-800">GeoCheck</h1>
                  <p className="text-slate-500">Employee Attendance System</p>
                </div>

                <Card className="p-7">
                  <div className="flex items-center justify-between mb-5">
                    <h2 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                      {authMode === "login" ? <Icons.LogIn size={20}/> : <Icons.UserPlus size={20}/>}
                      {authMode === "login" ? "Employee Login" : "New Account"}
                    </h2>
                  </div>

                  {authMode === "register" && (
                    <Input
                      label="Full Name"
                      placeholder="John Doe"
                      value={authForm.name}
                      onChange={e => setAuthForm({ ...authForm, name: e.target.value })}
                    />
                  )}

                  <Input
                    label="Email"
                    type="email"
                    placeholder="name@chula.ac.th"
                    value={authForm.email}
                    onChange={e => setAuthForm({ ...authForm, email: e.target.value })}
                  />
                  <Input
                    label="Password"
                    type="password"
                    placeholder="••••••••"
                    value={authForm.password}
                    onChange={e => setAuthForm({ ...authForm, password: e.target.value })}
                  />

                  {authMode === "login" ? (
                    <Button onClick={handleLogin} disabled={loading}>
                      {loading ? "Signing in..." : "Sign In"}
                    </Button>
                  ) : (
                    <Button onClick={handleRegister} disabled={loading} variant="success">
                      {loading ? "Creating..." : "Create Account"}
                    </Button>
                  )}

                  <div className="mt-5 pt-5 border-t border-slate-100 text-center">
                    <button
                      className="text-blue-600 font-semibold hover:underline text-sm"
                      onClick={() => {
                        setAuthMode(authMode === "login" ? "register" : "login");
                        setAuthForm({ name:"", email:"", password:"" });
                      }}
                    >
                      {authMode === "login" ? "Register New Employee" : "Back to Login"}
                    </button>

                    <div className="text-xs text-slate-400 mt-4">
                      Uses Apps Script API (Option A). No CSV fetch.
                    </div>
                  </div>
                </Card>
              </div>
            </div>
          ) : (
            <>
              <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                <div className="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
                  <div className="flex items-center font-extrabold text-lg text-slate-800">
                    <Icons.CheckCircle className="text-blue-600 mr-2" size={22} /> GeoCheck
                  </div>
                  <div className="flex items-center gap-3">
                    <div className="text-right hidden sm:block">
                      <div className="text-sm font-semibold text-slate-700">{currentUser.name}</div>
                      <div className="text-xs text-slate-400">ID: {currentUser.id || "-"}</div>
                    </div>
                    <button
                      onClick={handleLogout}
                      className="p-2 bg-slate-50 text-slate-500 rounded-full hover:bg-red-50 hover:text-red-600 transition"
                      title="Logout"
                    >
                      <Icons.LogOut size={18} />
                    </button>
                  </div>
                </div>
              </header>

              <main className="max-w-md mx-auto px-4 py-6 space-y-6">
                <Card className="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 shadow-lg">
                  <div className="flex justify-between items-end">
                    <div>
                      <p className="text-slate-300 text-sm font-semibold mb-1">Today's Status</p>
                      <h2 className="text-3xl font-bold font-mono">{formatClock(clock)}</h2>
                      <div className="text-xs text-slate-300 mt-1">{todayKey}</div>
                    </div>
                    <div className={`px-3 py-1 rounded-full text-xs font-extrabold ${
                      status.checkedOut ? "bg-slate-600" :
                      status.checkedIn ? "bg-emerald-500" :
                      isLateNow ? "bg-orange-500" : "bg-blue-500"
                    }`}>
                      {status.checkedOut ? "COMPLETED" : status.checkedIn ? "WORKING" : isLateNow ? "LATE START" : "READY"}
                    </div>
                  </div>

                  {status.checkedIn && (
                    <div className="mt-4 pt-4 border-t border-white/10 flex gap-4 text-xs text-slate-200">
                      <div>In: <span className="text-white font-mono">{status.checkInTime}</span></div>
                      {status.checkedOut && <div>Out: <span className="text-white font-mono">{status.checkOutTime}</span></div>}
                    </div>
                  )}
                </Card>

                <Card className="p-5">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-slate-800 flex items-center">
                      <Icons.BarChart size={18} className="mr-2 text-indigo-600" />
                      Monthly Attendance
                    </h3>
                    <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">This Month</span>
                  </div>

                  <ProgressBar label="Late Occurrences" current={monthlyStats.lateCount} max={config.maxLateCount} />
                  <ProgressBar label="Late Minutes" current={monthlyStats.lateMinutes} max={config.maxLateMinutes} />

                  <div className="text-xs text-slate-400 mt-2 text-center">
                    Limits: {config.maxLateCount} times / {config.maxLateMinutes} minutes per month
                  </div>
                </Card>

                <Card className="p-5">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-slate-800 flex items-center">
                      <Icons.MapPin size={18} className="mr-2 text-blue-600" />
                      Location Check
                    </h3>
                    {locationStatus.matchedLocation && (
                      <span className="text-xs font-semibold bg-blue-50 text-blue-700 px-2 py-1 rounded">
                        {locationStatus.matchedLocation.name}
                      </span>
                    )}
                  </div>

                  {!locationStatus.coords ? (
                    <div className="text-center py-6 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                      <Button onClick={getLocation} disabled={locationStatus.loading} variant="ghost">
                        <span className="inline-flex items-center gap-2">
                          <Icons.Navigation size={16} />
                          {locationStatus.loading ? "Locating..." : "Verify Location"}
                        </span>
                      </Button>
                      <p className="text-xs text-slate-400 mt-3">GPS permission required.</p>
                      {locationStatus.error && (
                        <p className="mt-3 text-red-600 text-sm flex items-center justify-center gap-2">
                          <Icons.AlertTriangle size={14} /> {locationStatus.error}
                        </p>
                      )}
                    </div>
                  ) : (
                    <div className="space-y-3">
                      <div className="flex justify-between items-center bg-slate-50 p-3 rounded-lg">
                        <span className="text-sm text-slate-500">Distance</span>
                        <span className={`font-extrabold text-lg ${
                          locationStatus.distance > (locationStatus.matchedLocation?.radius || 10) ? "text-red-600" : "text-green-600"
                        }`}>
                          {locationStatus.distance}m
                        </span>
                      </div>

                      {locationStatus.distance > (locationStatus.matchedLocation?.radius || 10) ? (
                        <div className="text-xs text-red-700 bg-red-50 p-2 rounded flex items-center gap-2">
                          <Icons.AlertTriangle size={14} /> Too far from {locationStatus.matchedLocation?.name}.
                        </div>
                      ) : (
                        <div className="text-xs text-green-700 bg-green-50 p-2 rounded flex items-center gap-2">
                          <Icons.CheckCircle size={14} /> Verified: {locationStatus.matchedLocation?.name}
                        </div>
                      )}

                      <button onClick={getLocation} className="text-xs text-blue-600 hover:underline w-full text-center">
                        Refresh GPS
                      </button>
                    </div>
                  )}
                </Card>

                <Card className="p-5">
                  {!status.checkedIn ? (
                    <>
                      {isLateNow && (
                        <div className="mb-4">
                          <label className="block text-sm font-semibold text-orange-700 mb-1">
                            Late Reason <span className="text-red-500">*</span>
                          </label>
                          <textarea
                            className="w-full px-3 py-2 bg-orange-50 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-slate-700 text-sm"
                            rows="2"
                            placeholder="Why are you late?"
                            value={lateReason}
                            onChange={e => setLateReason(e.target.value)}
                          />
                        </div>
                      )}

                      <Button onClick={() => handleAction("IN")} disabled={loading || !locationStatus.coords} variant="primary">
                        {loading ? "Saving..." : "SUBMIT CHECK-IN"}
                      </Button>
                    </>
                  ) : !status.checkedOut ? (
                    <div className="space-y-4">
                      <div className="bg-blue-50 text-blue-800 p-4 rounded-lg text-sm text-center">
                        You checked in at <strong>{status.checkInTime}</strong>.
                        <br />Ready to leave?
                      </div>
                      <Button onClick={() => handleAction("OUT")} disabled={loading || !locationStatus.coords} variant="danger">
                        {loading ? "Saving..." : "CHECK OUT"}
                      </Button>
                    </div>
                  ) : (
                    <div className="text-center py-4">
                      <div className="inline-block p-3 bg-green-100 text-green-600 rounded-full mb-3">
                        <Icons.CheckCircle size={32} />
                      </div>
                      <h3 className="text-lg font-extrabold text-slate-800">Shift Complete</h3>
                      <p className="text-slate-500 text-sm">Have a great evening!</p>
                    </div>
                  )}
                </Card>

                <Card className="p-5">
                  <div className="text-sm font-bold text-slate-800 mb-2">Debug</div>
                  <div className="text-xs text-slate-500 space-y-1">
                    <div>API: <span className="font-mono break-all">{API_URL}</span></div>
                    <div>Today Row: {todayRow ? "FOUND" : "NOT FOUND"}</div>
                    <div>Logs Loaded: {logs.length}</div>
                  </div>
                  <div className="mt-3">
                    <Button variant="ghost" onClick={() => refreshLogs(currentUser.id).then(()=>notify("Logs refreshed")).catch(e=>notify(e.message,"err"))}>
                      Refresh Logs from Sheet
                    </Button>
                  </div>
                </Card>

              </main>
            </>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
